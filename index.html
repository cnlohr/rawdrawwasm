 <!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Test</title>
		<style>
			body { background-color: #000080; }
			document : {overflow: hidden; width=100%; height=100%;}
		</style>
	</head>
	<body>
		<div STYLE="position:absolute;width:640;z-index:10;color:white">
			This is a demonstration of rawdrawwasm, a minimal technique to use C with rawdraw with WASM and without Emscripten.
			This file is a single-file HTML file. Thanks to @zNocturm and @redline2644.  Check out the project <A HREF=https://github.com/cnlohr/rawdrawwasm/>here</a>.
		</div>
		<div STYLE="positon:absolute;z-index:3">
			<canvas width=500 height=500 id=canvas></canvas>
		</div>
		<script>
var blob = atob('AGFzbQEAAAABOgtgAn9/AGABfwBgAABgA39/fwBgBH9/f38AYAF8AXxgBH99fX0AYAABf2ABfwF/ \
YAN9fX0BfWAAAXwCugIPA2VudhZDTkZHQ2xlYXJGcmFtZUludGVybmFsAAEDZW52F0NORkdTd2Fw \
QnVmZmVyc0ludGVybmFsAAIDZW52DUNORkdUYWNrUGl4ZWwAAANlbnYPQ05GR1RhY2tTZWdtZW50 \
AAQDZW52CUNORkdDb2xvcgAIA2VudhFPR0dldEFic29sdXRlVGltZQAKA2VudhNDTkZHU2V0dXBG \
dWxsc2NyZWVuAAADZW52D0NORkdIYW5kbGVJbnB1dAACA2VudhBDTkZHU2V0TGluZVdpZHRoAAED \
ZW52EUNORkdHZXREaW1lbnNpb25zAAADZW52EUNORkdUYWNrUmVjdGFuZ2xlAAQDZW52DENORkdU \
YWNrUG9seQAAA2VudgNjb3MABQNlbnYDc2luAAUDZW52Bm1lbW9yeQIAAgMNDAQAAwcJBgMAAwEC \
AQYSA38BQeDpBAt/AUEAC38BQQALB5ABCAlIYW5kbGVLZXkADwxIYW5kbGVCdXR0b24ADgxIYW5k \
bGVNb3Rpb24AEARtYWluABEVYXN5bmNpZnlfc3RhcnRfdW53aW5kABcUYXN5bmNpZnlfc3RvcF91 \
bndpbmQAGBVhc3luY2lmeV9zdGFydF9yZXdpbmQAGRRhc3luY2lmeV9zdG9wX3Jld2luZAAYCqYn \
DAMAAQsDAAELEwBBkBcgATYCAEHEyQAgADYCAAueIAMOfwt9BXwjAUECRgRAIwIjAigCAEGMf2o2 \
AgAjAigCACIAKAIAIQEgACgCBCECIAAqAgghDiAAKAIMIQMgACgCECEEIAAqAhQhECAAKAIYIQYg \
ACgCJCEHIAAoAighCCAAKgIsIRMgACoCMCEWIAAoAjQhCSAAKAI4IQogACoCPCEVIAAqAkAhFCAA \
KwJEIRsgACgCTCELIAAqAlAhEiAAKwJUIRwgACoCXCEXIAAqAmAhGCAAKwJkIR0gACgCbCEMIAAo \
AnAhDSAAKwIcIRkLAn8jAUECRgRAIwIjAigCAEF8ajYCACMCKAIAKAIAIQULIwFFBEAjAEHwAGsi \
AiQACyAFRUEBIwEbBEAQBUEAIwFBAUYNARohGQsgBUEBRkEBIwEbBEAQBUEBIwFBAUYNARohGQsj \
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 \
AyANlCAEIA6UkiAFIAyUkiAGIAuUkjgCACACIAMgCZQgBCAKlJIgBSAIlJIgBiAHlJI4AgwLGQBB \
ASQBIAAkAiMCKAIAIwIoAgRLBEAACwsVAEEAJAEjAigCACMCKAIESwRAAAsLGQBBAiQBIAAkAiMC \
KAIAIwIoAgRLBEAACwsLoQ8CAEGACAuND1Rlc3QgQmVuY2gAAAAAAAD//wAACAAQABgAHwApADIA \
MwD/////OQBCAP//SwBTAFwAYABkAGwAcgB7AIQAiQCTAJgAngCjAKkArACyALYA//+6AL0AwQDJ \
ANEA2QDiAOQA6ADsAPQA+AD6APwA/QD/AAUBCgEQARYBGwEhAScBLAE1ATwBPgFBAUQBSAFLAVEB \
WQFgAWoBcAF3AX4BhAGMAZIBmAGdAaYBqQGuAbMBugHBAcoB0gHYAdwB4AHlAewB9AH7AQACBAIG \
AgoCDQIPAhECGAIdAiICJwItAjQCPAJCAkUCSgJRAlMCXAJiAmcCbQJzAngCfgKCAogCjQKUApgC \
ngKiAqgCrAKyArYC//////////////////////////////////////////////////////////// \
/////////////////////////7wCvwLHAs4C2wLkAugC8gL0AvgC/gIEAwcDCQMRAxMDGAMeAyMD \
KwMtAzQDOwM8Az8DQQNGA0wDVQNeA2oDcAN5A4IDjAOXA6ADqwO3A8ADyQPSA9wD5QPtA/UD/gMG \
BA8EFwQeBCUELgQ3BD4EQgRLBFEEVwReBGQEbQR0BH4EhwSQBJoEpQSuBLkExgTPBNcE3wToBPAE \
9AT4BP0EAQUKBRQFGwUiBSoFMwU6BT4FRQVNBVUFXgVmBW4FdQX//wAJICkDIxSLAAkgKQQkE4wB \
ISMUAwkRmhEiIxQDApkBISMJAykDCRKcAysTHCMiEQKLmhoBISMDiQMhKiEZAxQjmgEQIRIJEhwD \
qwIDGwIaExCpASsDKQIRIhOKACIEiCACJKgBECkQFAsUqwALDCArrAAoAAIqEBwgrAEhIwMJIBAU \
jAMjJASLARApEBQLFCsErAEYIRCcAxwjHBCcAiIZIpsCKgIZApsBAqoCIhECE6oRIgKZAhMiihAb \
nBAJIJkQHCAsASkDqyEQASMUCxCcAAkjLAQDIaghEAESAxQrAqwQmRABA5wQISOcASsRGyELAqoC \
KhGbBJsCqpwDqQAgJAQImgEQHASsARAhIgSsACAkDBKqAAIqIKwgAAIiJIwgAiIkBIoAICESnAAM \
ACAsBCwCqgACIiAIIowZmxkTjCACrAEpA6sAIowBECESG5whAQQkIhITqwQBECEsAqoABBQjEgoS \
IRCIIxQDARCpABAhIxQEiAAELAAoApoADAAoApohEAEDFCMimgAMICwCqgAoEBwErAAgIxSLAAwC \
EiEoEiOsAASsBAARIKwEACogrAEQISMUA4kADAAQIRKKARAhIxQDCQSbAAwAECESAqwhEAEjFIsA \
KBCcAAQkqAADFCOoAAQsFBskqAABIywEAyGoAAESHBIhqAAgAgSsEAAEnAGrECAknAEQqQSsAJkC \
BCQqIxKKAAQkIookBAMSqiAkBAKqJAQCIiObBAkCGgEQqSMSAxQjJBWMAAwDEiOsGRKcKiMkFYwA \
DAMTKhOsEJwCDAIbEhwSI6wCDAMSI6wCIiQEigINBCQiigIELCUiigIMAxKqIgIDIySMERwCqgIE \
FCskqgIDFCOqAgMUGhMkqgIsBKoCAxwiI40CIgSsIBAULBKKEBkTnAAQFAwSqgEQEagDBCQjEosY \
EZwhEAECEyoQmxEABCQrApoBChEpIisDGwIRIhOKABEoERwCKgOrEBoTnSAAAhEqAhMiJIwIqCAQ \
EakQKSAhEZgRAhshEqsBIaoSqhAgIRkSGBGqAKgBECESiQIqERsDqwEQIQOrARAhEgoSI4sRqAIN \
BBQrIqwUEAEaECCsmhQVjSCpECAhEZgBEgsRIpsACQIoEhMrIqwACQIoEiITFKwAEBEJEQIoEhMr \
IqwYERIDFKsEAhEiLAMrEKkEAhEiLAMrAZgEAhEiLAMrARCpBAIRIiwDKwEQEagEAhEiLAMrCKgE \
AhEiLAMrACARiAAMAioAGRAcECgUrCMUAwEQKRQVjQIqAgQsAxsAmQIqAgQsAxsRqAIqAgQsAxsB \
EKkCKgIELAMbCKgCKhIcBCwAmQIqEhwELBGoAioSHAQsARCpAioSHAQsKIgAECEjFAQIApoEAiQq \
ARARqAIiJAQKAJkCIiQEChGoAiIkBAoRKACZAiIkBAoBEBGoASEkBAkIqAErA6kBECEjFAMJA6kB \
BCQpEagBBCQpAJkCBCQqARCpAQQkKQioAQITHBMiKRGoAAwBESITiwANABAhGgIiJIwCBCQqIxIK \
AJkCBCQqIxIKEagCBCQqIxIKARCpAgQkKiMSCgEQEagCBCQqIxIKCakCBCQqIxIKARAhiQIbAgQs \
EhwSKhMrIqsDBCwDEioUFY0kBAIiIxsAmSQEAiIjGxGoJAQCIiMbARCpJAQCIiMbCakSHACZEhwR \
qBIcARCpEhwJqQAqESgCIiQEigIMAxIjLAEQEagCBCQiCgCZAgQkIgoRqAIEJCIKARCpAgQkIgoB \
EBGoAgQkIgoJqRkCKpsCBCQiCgSqAgQUKyQqAJkCBBQrJCoRqAIEFCskKgEQqQIEFCskKgmpAgMc \
IiMNEagADAIRIhOKAgMcIiMNCakAQZAXCwZkAAAA4CQALwlwcm9kdWNlcnMBDHByb2Nlc3NlZC1i \
eQEFY2xhbmcPMTAuMC4wLTR1YnVudHUx');
var memory = new WebAssembly.Memory({initial:200});
var HEAP8 = new Int8Array(memory.buffer);
var HEAPU8 = new Uint8Array(memory.buffer);
var HEAP16 = new Int16Array(memory.buffer);
var HEAPU16 = new Uint16Array(memory.buffer);
var HEAP32 = new Uint32Array(memory.buffer);
var HEAPU32 = new Uint32Array(memory.buffer);
var HEAPF32 = new Float32Array(memory.buffer);
var HEAPF64 = new Float64Array(memory.buffer);
let toUtf8Decoder = new TextDecoder( "utf-8" );
function toUTF8(ptr) {
	var len = 0|0; ptr |= 0;
	for( var i = ptr; HEAPU8[i] != 0; i++) len++;
	return toUtf8Decoder.decode(HEAPU8.subarray(ptr, ptr+len));
}

let wasmExports;
const DATA_ADDR = 16; // Where the unwind/rewind data structure will live.
let sleeping = false;
var fullscreen = false;

//Configure WebGL Stuff
var canvas = document.getElementById('canvas');
var wgl = canvas.getContext('webgl');
var wgl_rdcolor = new Uint8Array(4);
var wgl_shader = null;
var wgl_blit = null;
var wgl_tex = null;

//Utility stuff for WebGL sahder creation.
function wgl_makeShader( vertText, fragText )
{
	var vert = wgl.createShader(wgl.VERTEX_SHADER);
	wgl.shaderSource(vert, vertText );
	wgl.compileShader(vert);
	if (!wgl.getShaderParameter(vert, wgl.COMPILE_STATUS)) {
			alert(wgl.getShaderInfoLog(vert));
	}

	var frag = wgl.createShader(wgl.FRAGMENT_SHADER);
	wgl.shaderSource(frag, fragText );
	wgl.compileShader(frag);
	if (!wgl.getShaderParameter(frag, wgl.COMPILE_STATUS)) {
			alert(wgl.getShaderInfoLog(frag));
	}
	var ret = wgl.createProgram();
	wgl.attachShader(ret, frag);
	wgl.attachShader(ret, vert);
	wgl.linkProgram(ret);
	wgl.bindAttribLocation( ret, 0, "a0" );
	wgl.bindAttribLocation( ret, 1, "a1" );
	return ret;
}

{
	wgl_shader = wgl_makeShader( 
		"uniform vec2 sw, sa; attribute vec2 a0; attribute vec4 a1; varying vec4 vc; void main() { gl_Position = vec4( a0*sw-sa, 0.0, 0.5 ); vc = a1; }",
		"precision mediump float; varying vec4 vc; void main() { gl_FragColor = vec4(vc.xyz,1.0); }" );

	swloc = wgl.getUniformLocation(wgl_shader, "sw" );
	saloc = wgl.getUniformLocation(wgl_shader, "sa" );

	wgl_blit = wgl_makeShader( 
		"uniform vec2 sw, sa;attribute vec2 a0; attribute vec4 a1; varying vec2 tc; void main() { gl_Position = vec4( a0*sw-sa, 0.0, 0.5 ); tc = a1.xy; }",
		"precision mediump float; varying vec2 tc; uniform sampler2D tex; void main() { gl_FragColor = texture2D(tex,tc);}" );

	swlocBlit = wgl.getUniformLocation(wgl_blit, "sw" );
	salocBlit = wgl.getUniformLocation(wgl_blit, "sa" );

	//Get us some nice shaders.

	//Compile the shaders.
	wgl.useProgram(wgl_shader);

	var arraybufferV = wgl.createBuffer();
	var arraybufferC = wgl.createBuffer();
	wgl.enableVertexAttribArray(0);
	wgl.enableVertexAttribArray(1);
}

//Do webgl work that must happen every frame.
function FrameStart()
{
	if( fullscreen )
	{
		wgl.viewportWidth = canvas.width = window.innerWidth;
		wgl.viewportHeight = canvas.height = window.innerHeight;
	}
	
	wgl.viewport( 0, 0, wgl.viewportWidth, wgl.viewportHeight );
	wgl.uniform2f( swloc, 1./wgl.viewportWidth, -1./wgl.viewportHeight );
	//XXX Is the nudge correct?
	//0.5, -.5 to fix center.
	//0.5/... to fix kerning so lines show up in middle of pixels.
	wgl.uniform2f( saloc, 0.5+0.5/wgl.viewportWidth, -.5-0.5/wgl.viewportHeight );
}

//Buffered geometry system.
//This handles buffering a bunch of lines/segments, and using them all at once.
var wgl_dcount;
var wgl_bdt;
var wgl_bds = 32768|0;
var wgl_bdal = new Float32Array( wgl_bds*2 );
var wgl_bdap = new Int16Array( wgl_bds*2 );
var wgl_bdac = new Uint8Array( wgl_bds*4 );

function WGLFBuffer()
{
	wgl.bindBuffer(wgl.ARRAY_BUFFER, arraybufferV);
	if( (wgl_bdt == wgl.TRIANGLES) )
	{
		wgl.bufferData(wgl.ARRAY_BUFFER, wgl_bdap, wgl.DYNAMIC_DRAW);
		wgl.vertexAttribPointer(0, 2, wgl.SHORT, false, 0, 0);
	}
	else
	{
		wgl.bufferData(wgl.ARRAY_BUFFER, wgl_bdal, wgl.DYNAMIC_DRAW);
		wgl.vertexAttribPointer(0, 2, wgl.FLOAT, false, 0, 0);
	}

	wgl.bindBuffer(wgl.ARRAY_BUFFER, arraybufferC);
	wgl.bufferData(wgl.ARRAY_BUFFER, wgl_bdac, wgl.DYNAMIC_DRAW);
	wgl.vertexAttribPointer(1, 4, wgl.UNSIGNED_BYTE, true, 0, 0);

	wgl.drawArrays(wgl_bdt, 0, wgl_dcount );
	wgl_dcount = 0;
}

const imports = {
	env: {

		CNFGTackSegment: (x1, y1, x2, y2) => {
			if( wgl_bdt != wgl.LINES || wgl_dcount > wgl_bds-4 ) WGLFBuffer();
			wgl_bdt = wgl.LINES;
			wgl_bdal.set( [x1,y1,x2,y2], wgl_dcount*2 );
			wgl_bdac.set( wgl_rdcolor, wgl_dcount*4 );
			wgl_bdac.set( wgl_rdcolor, wgl_dcount*4+4 );
			wgl_dcount += 2;
		},
		CNFGTackPixel : (x1, y1 ) => {
			if( wgl_bdt != wgl.LINES || wgl_dcount > wgl_bds-4 ) WGLFBuffer();
			wgl_bdt = wgl.LINES;
			//Hack, this looks like a pixel, But makes rendering really fast.
			wgl_bdal.set( [x1-.5,y1-.5,x1+.5,y1+.5], wgl_dcount*2 );
			wgl_bdac.set( wgl_rdcolor, wgl_dcount*4 );
			wgl_bdac.set( wgl_rdcolor, wgl_dcount*4+4 );
			wgl_dcount += 2;
		},
		CNFGTackRectangle : (x1, y1, x2, y2) => {
			if( wgl_bdt != wgl.TRIANGLES || wgl_dcount > wgl_bds-16 ) WGLFBuffer();
			wgl_bdt = wgl.TRIANGLES;
			wgl_bdap.set( [x1,y1,x2,y1,x2,y2,x1,y1,x2,y2,x1,y2], wgl_dcount*2 );
			wgl_bdac.set( wgl_rdcolor, wgl_dcount*4+0 );
			wgl_bdac.set( wgl_rdcolor, wgl_dcount*4+4 );
			wgl_bdac.set( wgl_rdcolor, wgl_dcount*4+8 );
			wgl_bdac.set( wgl_rdcolor, wgl_dcount*4+12 );
			wgl_bdac.set( wgl_rdcolor, wgl_dcount*4+16 );
			wgl_bdac.set( wgl_rdcolor, wgl_dcount*4+20 );
			wgl_dcount += 6;
		},
		CNFGTackPoly: (vertices, numverts) => {
			var i = 0 | 0;
			numverts |= 0;
			vertices |= 0;
			if( numverts < 1 ) return;
			wgl.enableVertexAttribArray(0);
			var outverts =  (numverts-2) * 3;
			if( wgl_bdt != wgl.TRIANGLES || wgl_dcount > wgl_bds-outverts*2 ) WGLFBuffer();
			var i = 0|0;
			for( ; i < (numverts-2); i++ )
			{
				wgl_bdac.set( wgl_rdcolor, wgl_dcount*4+0 );
				wgl_bdac.set( wgl_rdcolor, wgl_dcount*4+4 );
				wgl_bdac.set( wgl_rdcolor, wgl_dcount*4+8 );
				wgl_bdap.set( HEAP16.slice(vertices>>1,(vertices>>1)+6), wgl_dcount*2 );
				wgl_dcount += 3;
			}
			wgl_bdt = wgl.TRIANGLES;
		},
		CNFGColor : (color) => {
			wgl_rdcolor[0] = (color&0xff);
			wgl_rdcolor[1] = ((color>>8)&0xff);
			wgl_rdcolor[2] = ((color>>16)&0xff);
			wgl_rdcolor[3] = ((color>>24)&0xff);
		},
		CNFGSetup : (title,w,h ) => {
			document.title = toUTF8( title );
			wgl.viewportWidth = canvas.width = w;
			wgl.viewportHeight = canvas.height = h;
			FrameStart();
			fullscreen = false;
		},
		CNFGSetupFullscreen : (title,w,h ) => {
			document.title = toUTF8( title );
			wgl.viewportWidth = canvas.width = w;
			wgl.viewportHeight = canvas.height = h;
			FrameStart();
			canvas.style = "position:absolute; top:0; left:0;"
			fullscreen = true;
		},
		CNFGClearFrameInternal: ( color ) => {
			wgl.clearColor( (color&0xff)/255., ((color>>8)&0xff)/255., ((color>>16)&0xff)/255., ((color>>24)&0xff)/255. ); 
			wgl.clear( wgl.COLOR_BUFFER_BIT | wgl.COLOR_DEPTH_BIT );
		},
		CNFGGetDimensions: (pw, ph) => {
			HEAP16[pw>>1] = canvas.width;
			HEAP16[ph>>1] = canvas.height;
		},
		CNFGHandleInput: () => {
			//?? Do something here?
		},
		CNFGUpdateScreenWithBitmapInternal : (memptr, w, h ) => {
			if( w <= 0 || h <= 0 ) return;

			if( wgl_dcount > 0 ) WGLFBuffer();

			wgl.useProgram(wgl_blit);

			if( wgl_tex == null )	wgl_tex = wgl.createTexture(); //Most of the time we don't use textures, so don't initiate at start.

			wgl.activeTexture(wgl.TEXTURE0);
			wgl.bindTexture(wgl.TEXTURE_2D, wgl_tex);

			//Make a bogus quad.
			wgl_bdt = wgl.TRIANGLES;
			wgl_bdap.set( [0,0,    w,0,      w,h,        0,0,    w,h,        0,h ], 0 );
			wgl_bdac.set( [0,0,0,0,255,0,0,0,255,255,0,0,0,0,0,0,255,255,0,0,0,255,0,0], 0 );
			wgl_dcount = 6;
 
			wgl.uniform2f( swlocBlit, 1./wgl.viewportWidth, -1./wgl.viewportHeight );
			wgl.uniform2f( salocBlit, 0.5, -.5 );  //Note that unlike saloc, we don't have an extra offset.

			wgl.texParameteri(wgl.TEXTURE_2D, wgl.TEXTURE_WRAP_S, wgl.CLAMP_TO_EDGE);
			wgl.texParameteri(wgl.TEXTURE_2D, wgl.TEXTURE_WRAP_T, wgl.CLAMP_TO_EDGE);
			wgl.texParameteri(wgl.TEXTURE_2D, wgl.TEXTURE_MIN_FILTER, wgl.NEAREST);

 			var img = new Image();
			wgl.texImage2D(wgl.TEXTURE_2D, 0, wgl.RGBA, w, h,
				0, wgl.RGBA, wgl.UNSIGNED_BYTE, new Uint8Array(memory.buffer,memptr,w*h*4) );

			WGLFBuffer();

			wgl.useProgram(wgl_shader);
		},
		CNFGFlushRender : WGLFBuffer,
		CNFGSetLineWidth : (px) => { wgl.lineWidth( px ); },
		CNFGSwapBuffersInternal: () => {
			if (!sleeping) {
				WGLFBuffer();

				// We are called in order to start a sleep/unwind.
				// Fill in the data structure. The first value has the stack location,
				// which for simplicity we can start right after the data structure itself.
				HEAP32[DATA_ADDR >> 2] = DATA_ADDR + 8;
				// The end of the stack will not be reached here anyhow.
				HEAP32[DATA_ADDR + 4 >> 2] = 1024;
				wasmExports.asyncify_start_unwind(DATA_ADDR);
				sleeping = true;
				// Resume after the proper delay.
				requestAnimationFrame(function() {
					FrameStart();
					wasmExports.asyncify_start_rewind(DATA_ADDR);
					// The code is now ready to rewind; to start the process, enter the
					// first function that should be on the call stack.
					wasmExports.main();
				});
			} else {
				// We are called as part of a resume/rewind. Stop sleeping.
				wasmExports.asyncify_stop_rewind();
				sleeping = false;
			}
		},
		OGGetAbsoluteTime : () => { return new Date().getTime()/1000.; },
		Add1 : (i) => { return i+1; },
		sin : Math.sin,
		cos : Math.cos,
		tan : Math.tan,
		sinf : Math.sin,
		cosf : Math.cos,
		tanf : Math.tan,
		OGUSleep: (us) => {
			if (!sleeping) {
				// We are called in order to start a sleep/unwind.
				//console.log('sleep...');
				// Fill in the data structure. The first value has the stack location,
				// which for simplicity we can start right after the data structure itself.
				HEAP32[DATA_ADDR >> 2] = DATA_ADDR + 8;
				// The end of the stack will not be reached here anyhow.
				HEAP32[DATA_ADDR + 4 >> 2] = 1024;
				wasmExports.asyncify_start_unwind(DATA_ADDR);
				sleeping = true;
				// Resume after the proper delay.
				setTimeout(function() {
					wasmExports.asyncify_start_rewind(DATA_ADDR);
					// The code is now ready to rewind; to start the process, enter the
					// first function that should be on the call stack.
					wasmExports.main();
				}, us/1000);
			} else {
				// We are called as part of a resume/rewind. Stop sleeping.
				wasmExports.asyncify_stop_rewind();
				sleeping = false;
			}
		},
		memory: memory,
		print: console.log,
		draw: () => {},
		printc: (str, len) => { console.log(utf8decoder.decode(HEAPU8.subarray(str, str+len))) },
	}
};


{
	// Actually load the WASM blob.
	var array = new Uint8Array(new ArrayBuffer(blob.length));
	var i = 0|0;
	for(i = 0; i < blob.length; i++) {
		array[i] = blob.charCodeAt(i);
	}


	WebAssembly.instantiate(array, imports).then(
		function(wa) { 
			instance = wa.instance;
			wasmExports = instance.exports;

			if( instance.exports.HandleMotion )
				canvas.addEventListener('mousemove', e => { instance.exports.HandleMotion( e.offsetX, e.offsetY, e.buttons ); } );

			if( instance.exports.HandleButton )
			{
				canvas.addEventListener('mouseup', e => { instance.exports.HandleButton( e.offsetX, e.offsetY, e.button, 0 ); } );
				canvas.addEventListener('mousedown', e => { instance.exports.HandleButton( e.offsetX, e.offsetY, e.button, 1 ); } );
			}

			instance.exports.main();
		 } );
}
		</script>
	</body>
</html>
